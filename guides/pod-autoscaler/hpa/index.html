
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
      
        <link rel="canonical" href="https://cast.ai/guides/pod-autoscaler/hpa/">
      
      <link rel="shortcut icon" href="../../../img/favicon.ico">
      <meta name="generator" content="mkdocs-1.1.2, mkdocs-material-6.2.6">
    
    
      
        <title>Horizontal Pod Autoscaler - CAST AI Documentation</title>
      
    
    
      <link rel="stylesheet" href="../../../assets/stylesheets/main.cb6bc1d0.min.css">
      
        
        <link rel="stylesheet" href="../../../assets/stylesheets/palette.39b8e14a.min.css">
        
          
          
          <meta name="theme-color" content="#ffffff">
        
      
    
    
    
      
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Nimbus+Sans:300,400,400i,700%7C&display=fallback">
        <style>body,input{font-family:"Nimbus Sans",-apple-system,BlinkMacSystemFont,Helvetica,Arial,sans-serif}code,kbd,pre{font-family:"",SFMono-Regular,Consolas,Menlo,monospace}</style>
      
    
    
    
      <link rel="stylesheet" href="../../../stylesheets/extra.css">
    
    
      
    
    
  </head>
  
  
    
    
    
    
    
    <body dir="ltr" data-md-color-scheme="" data-md-color-primary="white" data-md-color-accent="indigo">
      
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#horizontal-pod-autoscaler" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
      

<header class="md-header" data-md-component="header">
  <nav class="md-header-nav md-grid" aria-label="Header">
    <a href="https://cast.ai" title="CAST AI Documentation" class="md-header-nav__button md-logo" aria-label="CAST AI Documentation">
      <img src="../../../img/cast-logo-dark-blue.svg" alt="Cast logo" style="width: 5em;" />
    </a>
    <label class="md-header-nav__button md-icon" for="__drawer">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2z"/></svg>
    </label>
    <div class="md-header-nav__title" data-md-component="header-title">
      <div class="md-header-nav__ellipsis">
        <div class="md-header-nav__topic">
          <span class="md-ellipsis">
            CAST AI Documentation
          </span>
        </div>
        <div class="md-header-nav__topic">
          <span class="md-ellipsis">
            
              Horizontal Pod Autoscaler
            
          </span>
        </div>
      </div>
    </div>
    
      <label class="md-header-nav__button md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0116 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 019.5 16 6.5 6.5 0 013 9.5 6.5 6.5 0 019.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg>
      </label>
      
<div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" data-md-state="active" required>
      <label class="md-search__icon md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0116 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 019.5 16 6.5 6.5 0 013 9.5 6.5 6.5 0 019.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
      </label>
      <button type="reset" class="md-search__icon md-icon" aria-label="Clear" data-md-component="search-reset" tabindex="-1">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41z"/></svg>
      </button>
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
      <div class="md-header-nav__source">
        
      </div>
    
  </nav>
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    




<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="https://cast.ai" title="CAST AI Documentation" class="md-nav__button md-logo" aria-label="CAST AI Documentation">
      <img src="../../../img/cast-logo-dark-blue.svg" alt="Cast logo" style="width: 5em;" />
    </a>
    CAST AI Documentation
  </label>
  
    <div class="md-nav__source">
      
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../../.." class="md-nav__link">
        Introduction
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../../../getting-help/" class="md-nav__link">
        Getting help
      </a>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="nav-3" type="checkbox" id="nav-3" >
      
      <label class="md-nav__link" for="nav-3">
        Getting started
        <span class="md-nav__icon md-icon"></span>
      </label>
      <nav class="md-nav" aria-label="Getting started" data-md-level="1">
        <label class="md-nav__title" for="nav-3">
          <span class="md-nav__icon md-icon"></span>
          Getting started
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../../getting-started/setting-up-account/" class="md-nav__link">
        Setting up an account
      </a>
    </li>
  

          
            
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="nav-3-2" type="checkbox" id="nav-3-2" >
      
      <label class="md-nav__link" for="nav-3-2">
        Setting up credentials
        <span class="md-nav__icon md-icon"></span>
      </label>
      <nav class="md-nav" aria-label="Setting up credentials" data-md-level="2">
        <label class="md-nav__title" for="nav-3-2">
          <span class="md-nav__icon md-icon"></span>
          Setting up credentials
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../../getting-started/configuring-gcp-credentials/" class="md-nav__link">
        Configure Google Cloud credentials
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../../getting-started/configuring-aws-credentials/" class="md-nav__link">
        Configure AWS credentials
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../../getting-started/configuring-do-credentials/" class="md-nav__link">
        Configure Digital Ocean credentials
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../../getting-started/configuring-azure-credentials/" class="md-nav__link">
        Configure Azure credentials
      </a>
    </li>
  

          
        </ul>
      </nav>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../../getting-started/creating-your-first-cluster/" class="md-nav__link">
        Creating your first cluster
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../../getting-started/deploying-applications/" class="md-nav__link">
        Deploying Applications
      </a>
    </li>
  

          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="nav-4" type="checkbox" id="nav-4" >
      
      <label class="md-nav__link" for="nav-4">
        Concepts
        <span class="md-nav__icon md-icon"></span>
      </label>
      <nav class="md-nav" aria-label="Concepts" data-md-level="1">
        <label class="md-nav__title" for="nav-4">
          <span class="md-nav__icon md-icon"></span>
          Concepts
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../../concepts/how-it-works/" class="md-nav__link">
        How it works
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../../concepts/architecture-overview/" class="md-nav__link">
        Cluster architecture overview
      </a>
    </li>
  

          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
    
  
  
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="nav-5" type="checkbox" id="nav-5" checked>
      
      <label class="md-nav__link" for="nav-5">
        Developer guides
        <span class="md-nav__icon md-icon"></span>
      </label>
      <nav class="md-nav" aria-label="Developer guides" data-md-level="1">
        <label class="md-nav__title" for="nav-5">
          <span class="md-nav__icon md-icon"></span>
          Developer guides
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../pod-pinning/" class="md-nav__link">
        Configure pod placement by topology
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../volumes/" class="md-nav__link">
        Dynamic volume provisioning
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../autoscaling-policies/" class="md-nav__link">
        Autoscaling policies
      </a>
    </li>
  

          
            
  
  
    
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" data-md-toggle="toc" type="checkbox" id="__toc">
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          Horizontal Pod Autoscaler
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        Horizontal Pod Autoscaler
      </a>
      
        
<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#scaling-an-application" class="md-nav__link">
    Scaling an application
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#horizontal-scaling-strategy" class="md-nav__link">
    Horizontal scaling strategy
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#the-hpa-keda" class="md-nav__link">
    The HPA &amp; KEDA
  </a>
  
    <nav class="md-nav" aria-label="The HPA &amp; KEDA">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#how-does-it-work" class="md-nav__link">
    How does it work
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#enabling-keda" class="md-nav__link">
    Enabling KEDA
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#examples" class="md-nav__link">
    Examples
  </a>
  
    <nav class="md-nav" aria-label="Examples">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#autoscale-based-on-cpu-andor-memory-usage" class="md-nav__link">
    Autoscale Based on CPU and/or Memory usage
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#autoscale-based-on-the-prometheus-metric" class="md-nav__link">
    Autoscale based on the Prometheus metric
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#troubleshooting" class="md-nav__link">
    Troubleshooting
  </a>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../ingress/" class="md-nav__link">
        Exposing your app to the internet
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../node-autoscaler/spot-instances/spot/" class="md-nav__link">
        Spot/Preemptible Instances
      </a>
    </li>
  

          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="nav-6" type="checkbox" id="nav-6" >
      
      <label class="md-nav__link" for="nav-6">
        API
        <span class="md-nav__icon md-icon"></span>
      </label>
      <nav class="md-nav" aria-label="API" data-md-level="1">
        <label class="md-nav__title" for="nav-6">
          <span class="md-nav__icon md-icon"></span>
          API
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../../api/overview/" class="md-nav__link">
        Introduction
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../../api/authentication/" class="md-nav__link">
        Authentication
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../../api/specification/" class="md-nav__link">
        API specification
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../../api/terraform-provider/" class="md-nav__link">
        Terraform provider
      </a>
    </li>
  

          
        </ul>
      </nav>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    
<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#scaling-an-application" class="md-nav__link">
    Scaling an application
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#horizontal-scaling-strategy" class="md-nav__link">
    Horizontal scaling strategy
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#the-hpa-keda" class="md-nav__link">
    The HPA &amp; KEDA
  </a>
  
    <nav class="md-nav" aria-label="The HPA &amp; KEDA">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#how-does-it-work" class="md-nav__link">
    How does it work
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#enabling-keda" class="md-nav__link">
    Enabling KEDA
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#examples" class="md-nav__link">
    Examples
  </a>
  
    <nav class="md-nav" aria-label="Examples">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#autoscale-based-on-cpu-andor-memory-usage" class="md-nav__link">
    Autoscale Based on CPU and/or Memory usage
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#autoscale-based-on-the-prometheus-metric" class="md-nav__link">
    Autoscale based on the Prometheus metric
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#troubleshooting" class="md-nav__link">
    Troubleshooting
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div class="md-content">
            <article class="md-content__inner md-typeset">
              
                
                  <a href="https://github.com/castai/docs/edit/main/docs/guides/pod-autoscaler/hpa.md" title="Edit this page" class="md-content__button md-icon">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20.71 7.04c.39-.39.39-1.04 0-1.41l-2.34-2.34c-.37-.39-1.02-.39-1.41 0l-1.84 1.83 3.75 3.75M3 17.25V21h3.75L17.81 9.93l-3.75-3.75L3 17.25z"/></svg>
                  </a>
                
                
                <h1 id="horizontal-pod-autoscaler">Horizontal Pod Autoscaler<a class="headerlink" href="#horizontal-pod-autoscaler" title="Permanent link">&para;</a></h1>
<h2 id="scaling-an-application">Scaling an application<a class="headerlink" href="#scaling-an-application" title="Permanent link">&para;</a></h2>
<p>You can scale an application in two ways:</p>
<ul>
<li>Vertically: by adding more resources (RAM/CPU/Disk IOPS) to the same instance,</li>
<li>Horizontally: by adding more instances (replicas) of the same application.</li>
</ul>
<p>The problem with vertical scaling is that you'll either find out that the required hardware (RAM, CPU, Disk IOPS) in a
single machine costs too much, or the cloud provider cannot provision a machine with enough resources. We use replica sets in Kubernetes to achieve horizontal scaling. The Horizontal Pod Autoscaler allows automating the process of maintaining the replica count proportionally to the application load.</p>
<h2 id="horizontal-scaling-strategy">Horizontal scaling strategy<a class="headerlink" href="#horizontal-scaling-strategy" title="Permanent link">&para;</a></h2>
<p>As mentioned above, the horizontal scaling strategy involves adding (or removing) the additional replicas of the same
application. The problem here lies in the fact that most application load patterns can have spikes that are not
predictable. This renders manual scaling nearly impossible. Luckily, we can automate this process!</p>
<h2 id="the-hpa-keda">The HPA &amp; KEDA<a class="headerlink" href="#the-hpa-keda" title="Permanent link">&para;</a></h2>
<p>Kubernetes comes equipped with the
<a href="https://kubernetes.io/docs/tasks/run-application/horizontal-pod-autoscale/">Horizontal Pod Autoscaler (HPA)</a>
functionality. It can scale up (add more replicas) or down (remove idling replicas) based on some metrics. The problem
is that HPA, by default, comes without batteries: it doesn't have the metrics' source. But you're in luck: CAST AI
bundles the batteries for you! We've got you covered by providing the <a href="https://keda.sh">KEDA</a> addon.</p>
<h3 id="how-does-it-work">How does it work<a class="headerlink" href="#how-does-it-work" title="Permanent link">&para;</a></h3>
<p>KEDA consists of two components:</p>
<ul>
<li><strong>operator</strong> -- watches k8s for ScaledObject resources and configures HPA accordingly</li>
<li><strong>metrics-apiserver</strong> -- a bridge between Kubernetes and various scaling sources (including Prometheus)</li>
</ul>
<p>These components do the heavy lifting of configuring Kubernetes HPA and setting up the custom metric sources. This
enables us to autoscale almost any workload: <code>Deployment</code>, <code>ReplicaSet</code>, <code>ReplicationController</code>, or <code>StatefulSet</code>. KEDA
 does support autoscaling Jobs as well.</p>
<h3 id="enabling-keda">Enabling KEDA<a class="headerlink" href="#enabling-keda" title="Permanent link">&para;</a></h3>
<p>In order to take advantage of the autoscaling functionality, you must enable KEDA addon in the <code>Policies</code> page:</p>
<ol>
<li>
<p>Navigate to an existing cluster (in case you don't have one already, go ahead and <a href="../../../getting-started/creating-your-first-cluster/">create one</a>)</p>
</li>
<li>
<p>On the left navigation menu, select <code>Policies</code>: <img alt="Navigate to policies" src="../010_navigate.png" /></p>
</li>
<li>
<p>Enable the Horizontal pod autoscaler <img alt="Enable" src="../020_enable.png" /></p>
</li>
</ol>
<h2 id="examples">Examples<a class="headerlink" href="#examples" title="Permanent link">&para;</a></h2>
<h3 id="autoscale-based-on-cpu-andor-memory-usage">Autoscale Based on CPU and/or Memory usage<a class="headerlink" href="#autoscale-based-on-cpu-andor-memory-usage" title="Permanent link">&para;</a></h3>
<p>Let's create a <code>Deployment</code> and a <code>Service</code> that we will <strong>Autoscale</strong>:</p>
<div class="highlight"><pre><span></span><code><span class="nt">apiVersion</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">apps/v1</span>
<span class="nt">kind</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">Deployment</span>
<span class="nt">metadata</span><span class="p">:</span>
  <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">sample-app</span>
  <span class="nt">labels</span><span class="p">:</span>
    <span class="nt">app</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">sample-app</span>
<span class="nt">spec</span><span class="p">:</span>
  <span class="c1"># Note that we omit the replica count so</span>
  <span class="c1"># when we redeploy, we wouldn&#39;t override</span>
  <span class="c1"># replica count set by the autoscaler</span>
  <span class="c1">#replicas: 1</span>
  <span class="nt">selector</span><span class="p">:</span>
    <span class="nt">matchLabels</span><span class="p">:</span>
      <span class="nt">app</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">sample-app</span>
  <span class="nt">template</span><span class="p">:</span>
    <span class="nt">metadata</span><span class="p">:</span>
      <span class="nt">labels</span><span class="p">:</span>
        <span class="nt">app</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">sample-app</span>
    <span class="nt">spec</span><span class="p">:</span>
      <span class="nt">containers</span><span class="p">:</span>
      <span class="p p-Indicator">-</span> <span class="nt">image</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">luxas/autoscale-demo:v0.1.2</span>
        <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">sample-app</span>
        <span class="nt">ports</span><span class="p">:</span>
        <span class="p p-Indicator">-</span> <span class="nt">containerPort</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">8080</span>
<span class="nn">---</span>
<span class="nt">apiVersion</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">v1</span>
<span class="nt">kind</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">Service</span>
<span class="nt">metadata</span><span class="p">:</span>
  <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">sample-app</span>
  <span class="nt">labels</span><span class="p">:</span>
    <span class="nt">app</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">sample-app</span>
<span class="nt">spec</span><span class="p">:</span>
  <span class="nt">ports</span><span class="p">:</span>
  <span class="p p-Indicator">-</span> <span class="nt">port</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">8080</span>
    <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">http</span>
    <span class="nt">targetPort</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">8080</span>
    <span class="nt">protocol</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">TCP</span>
  <span class="nt">selector</span><span class="p">:</span>
    <span class="nt">app</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">sample-app</span>
</code></pre></div>
<p><strong>Note</strong>: We don't specify the ReplicaCount ourselves</p>
<p>Now let us set up a <a href="https://keda.sh/docs/2.0/scalers/cpu/">CPU-based Autoscaler</a></p>
<div class="highlight"><pre><span></span><code><span class="nt">apiVersion</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">keda.sh/v1alpha1</span>
<span class="nt">kind</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">ScaledObject</span>
<span class="nt">metadata</span><span class="p">:</span>
  <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">sample-app</span>
<span class="nt">spec</span><span class="p">:</span>
  <span class="nt">scaleTargetRef</span><span class="p">:</span>
    <span class="nt">name</span><span class="p">:</span>          <span class="l l-Scalar l-Scalar-Plain">sample-app</span>
  <span class="nt">minReplicaCount</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">1</span>        <span class="c1"># Optional. Default: 0</span>
  <span class="nt">maxReplicaCount</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">10</span>       <span class="c1"># Optional. Default: 100</span>
  <span class="nt">triggers</span><span class="p">:</span>
    <span class="c1"># Either of the triggers can be omitted.</span>
    <span class="p p-Indicator">-</span> <span class="nt">type</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">cpu</span>
      <span class="nt">metadata</span><span class="p">:</span>
        <span class="c1"># Possible values: `Value`, `Utilization`, or `AverageValue`.</span>
        <span class="c1"># More info at: https://keda.sh/docs/2.0/scalers/cpu/#trigger-specification</span>
        <span class="nt">type</span><span class="p">:</span> <span class="s">&quot;Value&quot;</span>
        <span class="nt">value</span><span class="p">:</span> <span class="s">&quot;30&quot;</span>
    <span class="p p-Indicator">-</span> <span class="nt">type</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">memory</span>
      <span class="nt">metadata</span><span class="p">:</span>
        <span class="c1"># Possible values: `Value`, `Utilization`, or `AverageValue`.</span>
        <span class="c1"># More info at: https://keda.sh/docs/2.0/scalers/memory/</span>
        <span class="nt">type</span><span class="p">:</span> <span class="s">&quot;Value&quot;</span>
        <span class="nt">value</span><span class="p">:</span> <span class="s">&quot;512&quot;</span>
</code></pre></div>
<p>Now our Deployment autoscaling will be triggered either by CPU or Memory usage. We could use any other trigger, or remove
either of those if we want (i.e. to autoscale only on the <strong>CPU</strong> basis, remove the <strong>Memory</strong> trigger, and vice-versa).</p>
<h3 id="autoscale-based-on-the-prometheus-metric">Autoscale based on the Prometheus metric<a class="headerlink" href="#autoscale-based-on-the-prometheus-metric" title="Permanent link">&para;</a></h3>
<p>It's possible to autoscale based on the result of an arbitrary Prometheus query. What's more, CAST AI k8s clusters come with
Prometheus deployed out of the box!</p>
<p>Let's deploy the sample app again. But this time, let's instruct Prometheus to scrape metrics:</p>
<div class="highlight"><pre><span></span><code><span class="nt">apiVersion</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">apps/v1</span>
<span class="nt">kind</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">Deployment</span>
<span class="nt">metadata</span><span class="p">:</span>
  <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">sample-app</span>
  <span class="nt">labels</span><span class="p">:</span>
    <span class="nt">app</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">sample-app</span>
<span class="nt">spec</span><span class="p">:</span>
  <span class="nt">selector</span><span class="p">:</span>
    <span class="nt">matchLabels</span><span class="p">:</span>
      <span class="nt">app</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">sample-app</span>
  <span class="nt">template</span><span class="p">:</span>
    <span class="nt">metadata</span><span class="p">:</span>
      <span class="nt">labels</span><span class="p">:</span>
        <span class="nt">app</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">sample-app</span>
      <span class="nt">annotations</span><span class="p">:</span>
        <span class="c1"># These annotations the main difference!</span>
        <span class="nt">prometheus.io/path</span><span class="p">:</span> <span class="s">&quot;/metrics&quot;</span>
        <span class="nt">prometheus.io/port</span><span class="p">:</span> <span class="s">&quot;8080&quot;</span>
        <span class="nt">prometheus.io/scrape</span><span class="p">:</span> <span class="s">&quot;true&quot;</span>
    <span class="nt">spec</span><span class="p">:</span>
      <span class="nt">containers</span><span class="p">:</span>
      <span class="p p-Indicator">-</span> <span class="nt">image</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">luxas/autoscale-demo:v0.1.2</span>
        <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">sample-app</span>
        <span class="nt">ports</span><span class="p">:</span>
        <span class="p p-Indicator">-</span> <span class="nt">containerPort</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">8080</span>
<span class="nn">---</span>
<span class="nt">apiVersion</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">v1</span>
<span class="nt">kind</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">Service</span>
<span class="nt">metadata</span><span class="p">:</span>
  <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">sample-app</span>
  <span class="nt">labels</span><span class="p">:</span>
    <span class="nt">app</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">sample-app</span>
<span class="nt">spec</span><span class="p">:</span>
  <span class="nt">ports</span><span class="p">:</span>
  <span class="p p-Indicator">-</span> <span class="nt">port</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">8080</span>
    <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">http</span>
    <span class="nt">targetPort</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">8080</span>
    <span class="nt">protocol</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">TCP</span>
  <span class="nt">selector</span><span class="p">:</span>
    <span class="nt">app</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">sample-app</span>
</code></pre></div>
<p>Now let's deploy the Autoscaler!</p>
<div class="highlight"><pre><span></span><code><span class="nt">apiVersion</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">keda.sh/v1alpha1</span>
<span class="nt">kind</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">ScaledObject</span>
<span class="nt">metadata</span><span class="p">:</span>
  <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">sample-app</span>
<span class="nt">spec</span><span class="p">:</span>
  <span class="nt">scaleTargetRef</span><span class="p">:</span>
    <span class="nt">name</span><span class="p">:</span>          <span class="l l-Scalar l-Scalar-Plain">sample-app</span>
  <span class="nt">minReplicaCount</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">1</span>        <span class="c1"># Optional. Default: 0</span>
  <span class="nt">maxReplicaCount</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">10</span>       <span class="c1"># Optional. Default: 100</span>
  <span class="nt">triggers</span><span class="p">:</span>
    <span class="p p-Indicator">-</span> <span class="nt">type</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">prometheus</span>
      <span class="nt">metadata</span><span class="p">:</span>
        <span class="nt">serverAddress</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">http://prom.castai:9090</span>
        <span class="nt">metricName</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">http_requests_total_sample_app</span>
        <span class="nt">threshold</span><span class="p">:</span> <span class="s">&#39;1&#39;</span>
        <span class="c1"># Note: query must return a vector/scalar single element response</span>
        <span class="nt">query</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">sum(rate(http_requests_total{app=&quot;sample-app&quot;}[2m]))</span>
</code></pre></div>
<p>Now let's generate some load and observe that the replica count is increased:</p>
<div class="highlight"><pre><span></span><code><span class="c1"># Deploy busybox image</span>
kubectl run -it --rm load-generator --image<span class="o">=</span>busybox /bin/sh

<span class="c1"># Hit ENTER for command prompt</span>

<span class="c1"># trigger infinite requests to the php-apache server</span>
<span class="k">while</span> true<span class="p">;</span> <span class="k">do</span> wget -q -O- http://sample-app:8080/metrics<span class="p">;</span> <span class="k">done</span>

<span class="c1"># in order to cancel, hold CTRL+C</span>
<span class="c1"># in order to quit, initiate CTRL+D sequence</span>
</code></pre></div>
<h2 id="troubleshooting">Troubleshooting<a class="headerlink" href="#troubleshooting" title="Permanent link">&para;</a></h2>
<p>Verify that KEDA is scheduled and running (the suffixes might be different):</p>
<div class="highlight"><pre><span></span><code>$ kubectl get pods -n keda
NAME                                      READY   STATUS    RESTARTS   AGE
keda-metrics-apiserver-59679c9f96-5lfr5   <span class="m">1</span>/1     Running   <span class="m">0</span>          74m
keda-operator-66744fc69d-7njdd            <span class="m">1</span>/1     Running   <span class="m">0</span>          74m
</code></pre></div>
<p>Describe ScaledObject for clues. In this case, scaledObjectRef points to nonexistent object:</p>
<div class="highlight"><pre><span></span><code>$ kubectl describe scaledobjects.keda.sh sample-app
Name:         sample-app
Namespace:    default
Labels:       <span class="nv">scaledObjectName</span><span class="o">=</span>sample-app
Annotations:  API Version:  keda.sh/v1alpha1
Kind:         ScaledObject
Metadata:
  Creation Timestamp:  <span class="m">2020</span>-11-10T10:12:38Z
  Finalizers:
    finalizer.keda.sh
  Generation:  <span class="m">1</span>
  Managed Fields:
    &lt;... snip ...&gt;
  Resource Version:  <span class="m">394466</span>
  Self Link:         /apis/keda.sh/v1alpha1/namespaces/default/scaledobjects/sample-app
  UID:               9394d57a-ae66-4e80-baf4-8d6bb7fd36f9
Spec:
  Advanced:
    Horizontal Pod Autoscaler Config:
      Behavior:
        Scale Down:
          Policies:
            Period Seconds:              <span class="m">15</span>
            Type:                        Percent
            Value:                       <span class="m">100</span>
          Stabilization Window Seconds:  <span class="m">300</span>
    Restore To Original Replica Count:   <span class="nb">true</span>
  Cooldown Period:                       <span class="m">300</span>
  Max Replica Count:                     <span class="m">10</span>
  Min Replica Count:                     <span class="m">1</span>
  Polling Interval:                      <span class="m">30</span>
  Scale Target Ref:
    API Version:  apps/v1
    Kind:         Deployment
    Name:         sample-app
  Triggers:
    Metadata:
      Metric Name:     http_requests_total
      Query:           sum<span class="o">(</span>rate<span class="o">(</span>http_requests_total<span class="o">{</span><span class="nv">app</span><span class="o">=</span><span class="s2">&quot;sample-app&quot;</span><span class="o">}[</span>2m<span class="o">]))</span>
      Server Address:  http://prom.castai:9090
      Threshold:       <span class="m">1</span>
    Type:              prometheus
Status:
  Conditions:
    Message:  ScaledObject doesn<span class="s1">&#39;t have correct scaleTargetRef specification</span>
<span class="s1">    Reason:   ScaledObjectCheckFailed</span>
<span class="s1">    Status:   False         &lt;--------- This means that this check didn&#39;</span>t pass
    Type:     Ready
    Message:  ScaledObject check failed
    Reason:   UnkownState
    Status:   Unknown
    Type:     Active
Events:       &lt;none&gt;
</code></pre></div>
<p>Inspect KEDA operator logs:</p>
<div class="highlight"><pre><span></span><code>kubectl logs -n keda <span class="k">$(</span>kubectl get pods -n keda -o name <span class="p">|</span> grep operator<span class="k">)</span>
</code></pre></div>
                
              
              
                


              
            </article>
          </div>
        </div>
      </main>
      
        
<footer class="md-footer">
  
    <div class="md-footer-nav">
      <nav class="md-footer-nav__inner md-grid" aria-label="Footer">
        
          <a href="../../autoscaling-policies/" class="md-footer-nav__link md-footer-nav__link--prev" rel="prev">
            <div class="md-footer-nav__button md-icon">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
            </div>
            <div class="md-footer-nav__title">
              <div class="md-ellipsis">
                <span class="md-footer-nav__direction">
                  Previous
                </span>
                Autoscaling policies
              </div>
            </div>
          </a>
        
        
          <a href="../../ingress/" class="md-footer-nav__link md-footer-nav__link--next" rel="next">
            <div class="md-footer-nav__title">
              <div class="md-ellipsis">
                <span class="md-footer-nav__direction">
                  Next
                </span>
                Exposing your app to the internet
              </div>
            </div>
            <div class="md-footer-nav__button md-icon">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11H4z"/></svg>
            </div>
          </a>
        
      </nav>
    </div>
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      
    </div>
  </div>
</footer>
      
    </div>
    
      <script src="../../../assets/javascripts/vendor.53cc9318.min.js"></script>
      <script src="../../../assets/javascripts/bundle.e9c9f54f.min.js"></script><script id="__lang" type="application/json">{"clipboard.copy": "Copy to clipboard", "clipboard.copied": "Copied to clipboard", "search.config.lang": "en", "search.config.pipeline": "trimmer, stopWordFilter", "search.config.separator": "[\\s\\-]+", "search.placeholder": "Search", "search.result.placeholder": "Type to start searching", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.term.missing": "Missing"}</script>
      
      <script>
        app = initialize({
          base: "../../..",
          features: [],
          search: Object.assign({
            worker: "../../../assets/javascripts/worker/search.9c0e82ba.min.js"
          }, typeof search !== "undefined" && search)
        })
      </script>
      
    
  </body>
</html>